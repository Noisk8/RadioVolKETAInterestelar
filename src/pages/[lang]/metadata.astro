---
import PageLayout from "../../layouts/PageLayout.astro";
import { SITE_TITLE } from "../../config";
import PageMeta from "../../components/PageMeta.astro";
import { t, normalizeLang } from "../../i18n";
import { readAll } from "../../lib/markdoc/read";
import { metadata } from "../../lib/markdoc/metadata.schema";
import "../../styles/metadata.css";

export async function getStaticPaths() {
  return ["es", "en", "fr"].map((lang) => ({ params: { lang } }));
}

const lang = normalizeLang(Astro.params.lang as string);
const locale = lang === 'en' ? 'en-US' : lang === 'fr' ? 'fr-FR' : 'es-ES';
// Obtener todos los metadatos
const allMetadata = await readAll({
  directory: "metadata",
  frontmatterSchema: metadata,
});

// Ordenar por fecha (más recientes primero)
const sortedMetadata = allMetadata
  .filter((item) => item.frontmatter.draft !== true)
  .sort(
    (a, b) =>
      new Date(b.frontmatter.date).valueOf() - 
      new Date(a.frontmatter.date).valueOf()
  );

// Formatear fecha en español
function formatDate(date: string | Date): string {
  return new Date(date).toLocaleDateString(locale, {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}
---

<PageLayout title={t(lang,'metadata.title')} containerClass="max-w-6xl">
  <PageMeta 
    title={`${SITE_TITLE} | ${t(lang,'metadata.title')}`} 
    description={t(lang,'metadata.intro')}
    slot="meta" 
  />
  
  <main slot="main">
    <section class="metadata-view">
      <header class="metadata-header">
        <h1>{t(lang,'metadata.title')}</h1>
        <p class="metadata-intro">{t(lang,'metadata.intro')}</p>
      </header>

      <div class="metadata-grid">
        {sortedMetadata.map((item) => {
          const { title, description, date, imageUrl, audioUrl, tracks } = item.frontmatter;
          const hasAudio = !!audioUrl;
          const hasTracks = tracks && tracks.length > 0;
          
          return (
            <article class="metadata-card">
              <a href={`/metadata/${item.slug}`} class="card-link">
                <div class="metadata-image">
                  <img
                    src={imageUrl}
                    alt={title}
                    loading="lazy"
                    width="400"
                    height="225"
                  />
                  <div class="image-overlay"></div>
                  {hasAudio && (
                    <div class="audio-indicator" title={t(lang,'metadata.audio_indicator')}>
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M11 5 6 9H3v6h3l5 4V5zm8.07-.07a10 10 0 0 1 0 14.14l-1.41-1.41a8 8 0 0 0 0-11.32l1.41-1.41zm-3.53 3.53a5 5 0 0 1 0 7.08l-1.42-1.42a3 3 0 0 0 0-4.24l1.42-1.42z"/>
                      </svg>
                    </div>
                  )}
                </div>

                <div class="metadata-content">
                  <span class="metadata-date">{formatDate(date)}</span>
                  <h2 class="metadata-title">{title}</h2>
                  <p class="metadata-description">{description}</p>
                  <div class="metadata-footer">
                    <div class="metadata-tags">
                      {hasTracks && (
                        <span class="metadata-tag">{tracks.length} {tracks.length === 1 ? t(lang,'metadata.tracks_one') : t(lang,'metadata.tracks_other')}</span>
                      )}
                      {hasAudio && <span class="metadata-tag">{t(lang,'metadata.audio')}</span>}
                    </div>
                    <span class="metadata-audio">{t(lang,'metadata.details')}</span>
                  </div>
                </div>
              </a>
            </article>
          );
        })}
      </div>
    </section>
  </main>
</PageLayout>
