---
import PageLayout from "../../layouts/PageLayout.astro";
import PageMeta from "../../components/PageMeta.astro";
import { SITE_TITLE } from "../../config";
import { t, normalizeLang } from "../../i18n";
import { readAll } from "../../lib/markdoc/read";
import { setSchema } from "../../lib/markdoc/sets.schema";
import { getSoundCloudArtwork } from "../../lib/soundcloud";
import "../../styles/sets.css";

export async function getStaticPaths() {
  return ["es", "en", "fr"].map((lang) => ({ params: { lang } }));
}

const lang = normalizeLang(Astro.params.lang as string);
const locale = lang === 'en' ? 'en-US' : lang === 'fr' ? 'fr-FR' : 'es-ES';
const sets = await readAll({ directory: "sets", frontmatterSchema: setSchema });
const setsWithCovers = await Promise.all(
  sets.map(async (entry) => {
    let cover = entry.frontmatter.imageUrl;
    if (!cover) {
      cover = (await getSoundCloudArtwork(entry.frontmatter.soundcloudUrl)) ?? `/images/sets/${entry.slug}.jpeg`;
    }
    return { ...entry, cover };
  })
);

const sortedSets = setsWithCovers
  .filter((s) => s.frontmatter.draft !== true)
  .sort((a, b) => new Date(b.frontmatter.date).valueOf() - new Date(a.frontmatter.date).valueOf());

function formatDate(date: string | Date): string {
  return new Date(date).toLocaleDateString(locale, { year: "numeric", month: "long", day: "numeric" });
}
---

<PageLayout containerClass="max-w-6xl">
  <PageMeta title={`${t(lang,'nav.sets')} | ${SITE_TITLE}`} slot="meta" />
  <section slot="main" class="sets-view">
    <header class="sets-header">
      <span class="sets-chip">{t(lang,'sets.archive')}</span>
      <h1>{t(lang,'sets.title')}</h1>
      <p>{t(lang,'sets.subtitle')}</p>
    </header>

    <ul class="sets-grid">
      {sortedSets.map((entry) => {
        const { title } = entry.frontmatter;
        const cover = entry.cover;
        return (
          <li class="set-card">
            <a class="set-link" href={`/sets/${entry.slug}`}>
              <div class="set-image">
                <img src={cover} alt={title} loading="lazy" />
              </div>
              <div class="set-content">
                <span class="set-date">{formatDate(entry.frontmatter.date)}</span>
                <h2 class="set-title">{title}</h2>
              </div>
            </a>
          </li>
        );
      })}
    </ul>
  </section>
</PageLayout>
