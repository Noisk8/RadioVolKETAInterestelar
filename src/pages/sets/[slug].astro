---
import PageLayout from "../../layouts/PageLayout.astro";
import PageMeta from "../../components/PageMeta.astro";
import { readAll } from "../../lib/markdoc/read";
import { setSchema } from "../../lib/markdoc/sets.schema";

export async function getStaticPaths() {
  const sets = await readAll({ directory: "sets", frontmatterSchema: setSchema });
  const { getSoundCloudArtwork } = await import("../../lib/soundcloud");
  const withCovers = await Promise.all(
    sets.map(async (s) => {
      const fm = s.frontmatter;
      let imageUrl = fm.imageUrl;
      if (!imageUrl) {
        imageUrl = (await getSoundCloudArtwork(fm.soundcloudUrl)) ?? `/images/sets/${s.slug}.jpeg`;
      }
      return { params: { slug: s.slug }, props: { entry: s, imageUrl } };
    })
  );
  return withCovers;
}

const { entry, imageUrl: coverFromProps } = Astro.props as any;
const { slug } = entry;
const fm = entry.frontmatter;

const title: string = fm.title ?? "Set";
const description: string = fm.description ?? "";
const soundcloudUrl: string = fm.soundcloudUrl;
const date = new Date(fm.date);
const formattedDate = date.toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });

const embedUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(soundcloudUrl)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`;
---

<PageLayout containerClass="max-w-5xl">
  <PageMeta title={`${title} | Set`} description={description} slot="meta" />
  <main slot="main" class="set-view">
    <a href="/sets" class="back-chip">
      <span class="fa-solid fa-arrow-left-long" aria-hidden="true"></span>
      Volver
    </a>

    <article class="set-sheet">
      <header class="sheet-header">
        <span class="sheet-title">Set</span>
        <h1>{title}</h1>
        <time datetime={date.toISOString()}>{formattedDate}</time>
      </header>

      <section class="sheet-player">
        <p class="section-kicker">Escucha en SoundCloud</p>
        <div class="sc-embed">
          <iframe
            width="100%"
            height="420"
            scrolling="no"
            frameborder="no"
            allow="autoplay"
            title={`Reproductor SoundCloud: ${title}`}
            src={embedUrl}
          />
        </div>
        <p class="sc-link">
          <a href={soundcloudUrl} target="_blank" rel="noreferrer">Abrir en SoundCloud</a>
        </p>
      </section>

      {description && <p class="sheet-description">{description}</p>}
    </article>
  </main>
</PageLayout>

<style>
  .set-view { display: grid; gap: 2rem; }
  .back-chip { display: inline-flex; align-items: center; gap: 0.7rem; padding: 0.6rem 1.3rem; border-radius: 999px; border: 1.5px solid rgb(var(--color-border-ink)); background: rgb(var(--color-bg-card)); letter-spacing: 0.3em; text-transform: uppercase; font-size: 0.75rem; box-shadow: 5px 5px 0 rgba(var(--shadow-soft) / 0.12); width: fit-content; }
  .set-sheet { display: grid; gap: 1.6rem; border: 1.5px solid rgb(var(--color-border-ink)); background: rgb(var(--color-bg-card)); box-shadow: 12px 12px 0 rgba(var(--shadow-soft) / 0.16); padding: clamp(1.2rem, 2.5vw, 2rem); }
  .sheet-header { display: grid; gap: 0.6rem; text-align: center; }
  .sheet-title { display: inline-flex; align-self: center; padding: 0.35rem 0.9rem; border-radius: 999px; border: 1.5px solid rgb(var(--color-border-ink)); background: rgb(var(--color-bg-body)); letter-spacing: 0.3em; text-transform: uppercase; font-size: 0.7rem; box-shadow: 4px 4px 0 rgba(var(--shadow-soft) / 0.12); }
  .sheet-header h1 { font-size: clamp(2rem, 3.6vw, 2.6rem); font-weight: 600; color: rgb(var(--color-text-heading)); line-height: 1.1; }
  .sheet-header time { font-size: 0.85rem; letter-spacing: 0.3em; text-transform: uppercase; color: rgb(var(--color-text-muted)); }
  .section-kicker { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.3em; color: rgb(var(--color-text-muted)); margin-bottom: 0.6rem; }
  .sc-embed iframe { border: 1.5px solid rgb(var(--color-border-ink)); width: 100%; display: block; background: rgb(var(--color-bg-elevated)); }
  .sc-link { margin-top: 0.4rem; font-size: 0.9rem; }
  .sc-link a { color: rgb(var(--color-text-heading)); text-decoration: underline; }
  .sheet-description { font-size: 1.02rem; line-height: 1.7; color: rgb(var(--color-text-muted)); }
</style>
