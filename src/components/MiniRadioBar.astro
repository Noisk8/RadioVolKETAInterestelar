---
// Minimal live radio bar fixed at bottom
const STATUS_URL = "https://stream.noisk8.xyz/status-json.xsl";
const STREAM_URL = "https://stream.noisk8.xyz/kbalahradio.ogg";
---

<div class="mini-radio" role="region" aria-label="Radio en vivo">
  <button id="mini-toggle" class="mini-btn" aria-label="Reproducir radio">
    <span class="mini-icon" aria-hidden="true"></span>
  </button>
  <div class="mini-meta" aria-live="polite">
    <span id="mini-state" class="mini-live">OFFLINE</span>
    <span class="mini-title">
      <span id="mini-song"></span>
      <span id="mini-artist"></span>
    </span>
  </div>
  <audio id="mini-audio" preload="none" crossorigin="anonymous">
    <source src={STREAM_URL} type="audio/mpeg" />
  </audio>
</div>

<script>
  const el = document.currentScript?.previousElementSibling?.previousElementSibling;
</script>

<script is:inline>
  const STATUS_URL = "https://stream.noisk8.xyz/status-json.xsl";
  const STREAM_URL = "https://stream.noisk8.xyz/kbalahradio.ogg";
  const audio = document.getElementById('mini-audio');
  const btn = document.getElementById('mini-toggle');
  const state = document.getElementById('mini-state');
  const song = document.getElementById('mini-song');
  const artist = document.getElementById('mini-artist');

  function setStateLive(isLive) {
    if (!state) return;
    state.textContent = isLive ? 'EN VIVO' : 'OFFLINE';
    state.classList.toggle('is-live', !!isLive);
  }

  function updateBtn() {
    if (!btn || !audio) return;
    btn.classList.toggle('is-playing', !audio.paused);
    btn.setAttribute('aria-label', audio.paused ? 'Reproducir radio' : 'Detener radio');
  }

  async function fetchStatus() {
    try {
      const r = await fetch(STATUS_URL, { cache: 'no-store' });
      if (!r.ok) throw new Error('status');
      const j = await r.json();
      const s = Array.isArray(j?.icestats?.source) ? j.icestats.source[0] : j?.icestats?.source || j;
      const online = !!s;
      setStateLive(online);
      if (online) {
        song.textContent = s.title || '';
        artist.textContent = s.artist ? ` â€” ${s.artist}` : '';
      }
    } catch {
      setStateLive(false);
    }
  }

  btn?.addEventListener('click', () => {
    if (!audio) return;
    if (audio.paused) audio.play().catch(()=>{}); else audio.pause();
    updateBtn();
  });

  audio?.addEventListener('play', updateBtn);
  audio?.addEventListener('pause', updateBtn);
  audio?.addEventListener('error', () => setStateLive(false));

  fetchStatus();
  setInterval(fetchStatus, 12000);
</script>

<style>
  .mini-radio {
    position: fixed;
    left: 0; right: 0; bottom: 0;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.9rem;
    align-items: center;
    padding: 0.6rem 1rem;
    border-top: 1.5px solid rgb(var(--color-border-ink));
    background: rgb(var(--color-bg-card) / 0.96);
    backdrop-filter: blur(6px);
    z-index: 60;
  }
  .mini-btn {
    display: inline-flex;
    align-items: center; justify-content: center;
    width: 38px; height: 38px;
    border-radius: 10px;
    border: 1.5px solid rgb(var(--color-border-ink));
    background: rgb(var(--color-bg-body));
    box-shadow: 3px 3px 0 rgba(var(--shadow-soft) / 0.16);
    cursor: pointer;
  }
  .mini-icon { width: 0; height: 0; border-style: solid; border-width: 8px 0 8px 13px; border-color: transparent transparent transparent rgb(var(--color-border-ink)); transition: .2s ease; }
  .mini-btn.is-playing .mini-icon { border-width: 0; width: 13px; height: 13px; border-radius: 3px; background: rgb(var(--color-border-ink)); }

  .mini-meta { display: flex; align-items: center; gap: .6rem; min-width: 0; }
  .mini-live { font-size: .7rem; letter-spacing: .25em; text-transform: uppercase; color: rgb(var(--color-text-muted)); border: 1px solid rgb(var(--color-border-ink)); padding: .2rem .6rem; border-radius: 999px; }
  .mini-live.is-live { background: rgb(232 82 74 / 0.9); color: rgb(255 248 235 / 1); border-color: transparent; }
  .mini-title { color: rgb(var(--color-text-heading)); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mini-title #mini-artist { color: rgb(var(--color-text-muted)); }

  @media (max-width: 480px) {
    .mini-title { font-size: .9rem; }
  }
</style>

