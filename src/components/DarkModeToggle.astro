---
---
<mode-toggle class="flex">
  <button
    class="mode-toggle-button"
    id="mode-toggle"
    role="switch"
    type="button"
    tabindex="0"
    aria-checked="false"
    data-headlessui-state=""
  >
    <span class="sr-only">Alternar tema</span>
    <span id="mode-circle" class="toggle-indicator">
      <span class="toggle-icon toggle-icon--sun" aria-hidden="true">☀</span>
      <span class="toggle-icon toggle-icon--moon" aria-hidden="true">☾</span>
    </span>
  </button>
</mode-toggle>

<script>
  function updateHTMLTheme(mode: "light" | "dark") {
    const themeColorMetaTag = document.head.querySelector(
      'meta[name="theme-color"]'
    );

    if (mode === "dark") {
      document.documentElement.classList.remove("light");
      document.documentElement.classList.add("dark");
      if (themeColorMetaTag) {
        // @ts-ignore
        themeColorMetaTag.content = "#12110E";
      }
    } else {
      document.documentElement.classList.remove("dark");
      document.documentElement.classList.add("light");
      if (themeColorMetaTag) {
        // @ts-ignore
        themeColorMetaTag.content = "#f8f5e8";
      }
    }
  }
  function updateStorageTheme(mode: "light" | "dark") {
    try {
      localStorage.setItem("theme", mode);
    } catch {}
  }
  class ModeToggle extends HTMLElement {
    constructor() {
      super();
      let currentMode: "light" | "dark" =
        document.documentElement.classList.contains("dark") ? "dark" : "light";
      // userPref: 'light' | 'dark' | 'auto' (auto = no localStorage key)
      let userPref: "light" | "dark" | "auto" = (localStorage.getItem("theme") as any) || "auto";

      const toggle = this.querySelector("button");
      const iconElem = toggle?.querySelector("#mode-circle");
      const setAria = () => {
        if (!toggle) return;
        const label = userPref === "auto" ? "Tema: Automático" : `Tema: ${currentMode === "dark" ? "Oscuro" : "Claro"}`;
        toggle.setAttribute("aria-label", label);
      };

      if (iconElem) {
        iconElem.classList.add(currentMode === "dark" ? "is-dark" : "is-light");

        // Click: alterna entre claro / oscuro (preferencia explícita)
        let longPressTriggered = false;
        let pressTimer: number | undefined;
        const onClick = () => {
          if (longPressTriggered) { longPressTriggered = false; return; }
          const modeToSwitch = currentMode === "dark" ? "light" : "dark";
          iconElem.classList.toggle("is-dark", modeToSwitch === "dark");
          iconElem.classList.toggle("is-light", modeToSwitch === "light");
          updateHTMLTheme(modeToSwitch);
          updateStorageTheme(modeToSwitch);
          currentMode = modeToSwitch;
          userPref = modeToSwitch;
          setAria();
        };

        const toAuto = () => {
          try { localStorage.removeItem("theme"); } catch {}
          userPref = "auto";
          applySystem();
          setAria();
        };

        const onPressStart = () => {
          longPressTriggered = false;
          // 600ms long press → Auto
          pressTimer = window.setTimeout(() => { longPressTriggered = true; toAuto(); }, 600);
        };
        const onPressEnd = () => { if (pressTimer) window.clearTimeout(pressTimer); };

        toggle?.addEventListener("click", onClick);
        toggle?.addEventListener("mousedown", onPressStart);
        toggle?.addEventListener("touchstart", onPressStart, { passive: true });
        window.addEventListener("mouseup", onPressEnd);
        window.addEventListener("touchend", onPressEnd, { passive: true });

        // If user hasn't explicitly chosen a theme (no localStorage key),
        // follow the system preference and update toggle on change.
        try {
          // migrate legacy sessionStorage to localStorage
          const legacy = sessionStorage.getItem("theme");
          if (legacy && !localStorage.getItem("theme")) {
            localStorage.setItem("theme", legacy);
            sessionStorage.removeItem("theme");
          }
          const stored = localStorage.getItem("theme");
          const mql = window.matchMedia("(prefers-color-scheme: dark)");
          const applySystem = () => {
            // Only auto-apply when there's no explicit user choice
            if (localStorage.getItem("theme")) return;
            const modeToSwitch = mql.matches ? "dark" : "light";
            currentMode = modeToSwitch;
            iconElem.classList.toggle("is-dark", modeToSwitch === "dark");
            iconElem.classList.toggle("is-light", modeToSwitch === "light");
            updateHTMLTheme(modeToSwitch);
            userPref = "auto";
            setAria();
          };
          if (!stored) {
            // Sync immediately and then on changes
            applySystem();
            if (mql.addEventListener) mql.addEventListener("change", applySystem);
            else if (mql.addListener) mql.addListener(applySystem);
          }
          // expose for long-press handler
          // @ts-ignore
          window.applySystem = applySystem;
        } catch {}

        setAria();
      }
    }
  }

  customElements.define("mode-toggle", ModeToggle);
</script>

<style>
  .mode-toggle-button {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 3.5rem;
    height: 2rem;
    border-radius: 999px;
    border: 1.5px solid rgb(var(--color-border-ink));
    background: rgb(var(--color-bg-card));
    box-shadow: 4px 4px 0 rgba(var(--shadow-soft) / 0.15);
    transition: transform 0.2s ease;
  }

  .mode-toggle-button:focus-visible {
    outline: 2px solid rgba(var(--color-border-ink) / 0.6);
    outline-offset: 3px;
  }

  .mode-toggle-button:hover {
    transform: translateY(-1px);
  }

  .toggle-indicator {
    position: relative;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: rgb(var(--color-primary-yellow));
    display: grid;
    place-items: center;
    transition: transform 0.35s ease, background 0.35s ease;
  }

  .toggle-indicator.is-dark {
    transform: translateX(0.8rem);
    background: rgb(31 29 25 / 0.85);
    color: rgb(var(--color-primary-blue));
  }

  .toggle-indicator.is-light {
    transform: translateX(-0.8rem);
  }

  .toggle-icon {
    position: absolute;
    font-size: 0.85rem;
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .toggle-icon--sun {
    opacity: 1;
  }

  .toggle-indicator.is-dark .toggle-icon--sun {
    opacity: 0;
  }

  .toggle-indicator.is-dark .toggle-icon--moon {
    opacity: 1;
    color: rgb(var(--color-primary-yellow));
  }
</style>
